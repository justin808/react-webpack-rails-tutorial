kind: workload
name: postgres-stateful
description: postgres-stateful
spec:
  type: stateful
  containers:
    - cpu: 1000m
      memory: 512Mi
      env:
        # - name: POSTGRES_ARCHIVE_URI  #Use this var to control the automatic restore behavior. If you leave it out, the db will start empty.
        #   value: s3://YOUR_BUCKET/PATH_TO_ARCHIVE_FILE
        - name: PGDATA #The location postgres stores the db. This can be anything other than /var/lib/postgresql/data, but it must be inside the mount point for the volume set
          value: "/var/lib/postgresql/data/pg_data"
        - name: POSTGRES_DB #The name of the initial db
          value: test
        - name: POSTGRES_PASSWORD #The password for the default user
          value: cpln://secret/postgres-stateful-credentials.password
        - name: POSTGRES_USER #The name of the default user
          value: cpln://secret/postgres-stateful-credentials.username
      name: stateful
      image: postgres:15
      command: /bin/bash
      args:
        - "-c"
        - "cat /usr/local/bin/cpln-entrypoint.sh >> ./cpln-entrypoint.sh && chmod u+x ./cpln-entrypoint.sh && ./cpln-entrypoint.sh postgres"
      #command:  "cpln-entrypoint.sh"
      #args:
      #  - "postgres"
      ports:
        - number: 5432
          protocol: tcp
      volumes:
        - uri: cpln://volumeset/postgres-stateful-vs
          path: "/var/lib/postgresql/data"
        - uri: cpln://secret/postgres-stateful-entrypoint-script
          path: "/usr/local/bin/cpln-entrypoint.sh"
      inheritEnv: false
      livenessProbe:
        tcpSocket:
          port: 5432
        failureThreshold: 1
      readinessProbe:
        tcpSocket:
          port: 5432
        failureThreshold: 1
  identityLink: //identity/postgres-stateful-identity
  defaultOptions:
    capacityAI: false
    autoscaling:
      metric: cpu
      target: 95
      maxScale: 1
  firewallConfig:
    external:
      inboundAllowCIDR: []
      outboundAllowCIDR:
        - 0.0.0.0/0
    internal:
      inboundAllowType: same-gvc
